{% extends "base.html" %}

{% block content %}
<div class="max-w-6xl mx-auto px-4 py-4 sm:py-6">
    <!-- Header -->
    <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between mb-4 sm:mb-6 gap-3">
        <h1 class="text-xl sm:text-2xl lg:text-3xl font-bold flex items-center gap-2 sm:gap-3">
            <i class="fas fa-qrcode text-lg sm:text-xl text-blue-400"></i>
            <span>Geräte-Scanner</span>
        </h1>
        <a href="/lager/{{ session.current_lager }}" 
           class="text-sm sm:text-base text-gray-400 hover:text-white transition flex items-center touch-manipulation">
            <i class="fas fa-arrow-left mr-2"></i>Zurück zum Lager
        </a>
    </div>

    <!-- Scan Options -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-3 sm:gap-4 mb-4 sm:mb-6">
        <!-- Camera Scanner Card -->
        <div class="bg-gradient-to-br from-green-900 to-green-800 p-4 sm:p-6 rounded-xl shadow-lg border border-green-700 hover:shadow-green-900/50 transition-all duration-300">
            <div class="flex items-center mb-3 sm:mb-4">
                <div class="bg-green-600 p-2 sm:p-3 rounded-lg mr-3 sm:mr-4 flex-shrink-0">
                    <i class="fas fa-camera text-xl sm:text-2xl text-white"></i>
                </div>
                <div class="min-w-0">
                    <h2 class="text-lg sm:text-xl font-bold text-white truncate">Kamera Scanner</h2>
                    <p class="text-green-200 text-xs sm:text-sm">QR-Code mit Kamera scannen</p>
                </div>
            </div>
            <button id="startCameraBtn" 
                    class="w-full bg-green-600 hover:bg-green-500 active:bg-green-400 text-white font-bold py-2.5 sm:py-3 px-4 sm:px-6 rounded-lg transition-all duration-200 transform hover:scale-105 active:scale-95 shadow-lg touch-manipulation text-sm sm:text-base">
                <i class="fas fa-camera mr-2"></i>Kamera öffnen
            </button>
        </div>

        <!-- Manual Input Card -->
        <div class="bg-gradient-to-br from-blue-900 to-blue-800 p-4 sm:p-6 rounded-xl shadow-lg border border-blue-700 hover:shadow-blue-900/50 transition-all duration-300">
            <div class="flex items-center mb-3 sm:mb-4">
                <div class="bg-blue-600 p-2 sm:p-3 rounded-lg mr-3 sm:mr-4 flex-shrink-0">
                    <i class="fas fa-keyboard text-xl sm:text-2xl text-white"></i>
                </div>
                <div class="min-w-0">
                    <h2 class="text-lg sm:text-xl font-bold text-white truncate">Manuelle Eingabe</h2>
                    <p class="text-blue-200 text-xs sm:text-sm">Code manuell eingeben</p>
                </div>
            </div>
            <form method="POST" id="manualForm">
                <div class="space-y-2 sm:space-y-3">
                    <input type="text" 
                           id="qr_input" 
                           name="qr_code" 
                           class="w-full px-3 sm:px-4 py-2.5 sm:py-3 bg-blue-950 border-2 border-blue-600 rounded-lg text-white placeholder-blue-300 focus:outline-none focus:ring-2 focus:ring-blue-400 focus:border-transparent transition text-base sm:text-lg"
                           placeholder="QR-Code eingeben..." 
                           autofocus>
                    <button type="submit" 
                            name="search_device" 
                            class="w-full bg-blue-600 hover:bg-blue-500 active:bg-blue-400 text-white font-bold py-2.5 sm:py-3 px-4 sm:px-6 rounded-lg transition-all duration-200 transform hover:scale-105 active:scale-95 shadow-lg touch-manipulation text-sm sm:text-base">
                        <i class="fas fa-search mr-2"></i>Gerät suchen
                    </button>
                </div>
            </form>
        </div>
    </div>

    {% if searched and not device_info %}
    <!-- Error Message -->
    <div class="bg-red-900/50 border-2 border-red-600 rounded-xl p-4 sm:p-6 mb-4 sm:mb-6 animate-shake">
        <div class="flex items-start sm:items-center gap-3 sm:gap-4">
            <i class="fas fa-exclamation-triangle text-2xl sm:text-3xl text-red-400 flex-shrink-0 mt-1 sm:mt-0"></i>
            <div class="min-w-0">
                <h3 class="text-lg sm:text-xl font-bold text-white mb-1">Gerät nicht gefunden</h3>
                <p class="text-sm sm:text-base text-red-200 break-words">Kein Gerät mit dem Code <span class="font-mono font-bold">"{{ searched_code }}"</span> gefunden.</p>
                <p class="text-xs sm:text-sm text-red-300 mt-2">Bitte überprüfen Sie den Code und versuchen Sie es erneut.</p>
            </div>
        </div>
    </div>
    {% endif %}

    {% if device_info %}
    <!-- Static Device Info Display -->
    <div class="bg-gray-800 rounded-xl shadow-xl border border-gray-700 overflow-hidden">
        <!-- Header -->
        <div class="bg-gradient-to-r from-blue-600 to-blue-800 p-4 sm:p-6">
            <h2 class="text-xl sm:text-2xl font-bold text-white flex items-center gap-2 sm:gap-3">
                <i class="fas fa-info-circle"></i>
                <span>Geräte-Information</span>
            </h2>
        </div>

        <div class="p-4 sm:p-6">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 sm:gap-6">
                <!-- Left Column -->
                <div class="space-y-3 sm:space-y-4">
                    <!-- Basic Info -->
                    <div class="bg-gray-700/50 p-4 sm:p-5 rounded-lg border border-gray-600">
                        <h3 class="text-base sm:text-lg font-bold text-blue-400 mb-3 sm:mb-4 flex items-center gap-2">
                            <i class="fas fa-box"></i>
                            <span>Grunddaten</span>
                        </h3>
                        <div class="space-y-2 sm:space-y-3 text-xs sm:text-sm">
                            <div class="flex justify-between gap-2">
                                <span class="text-gray-400 flex-shrink-0">Name:</span>
                                <span class="font-semibold text-white text-right break-words">{{ device_info.name }}</span>
                            </div>
                            <div class="flex justify-between gap-2">
                                <span class="text-gray-400 flex-shrink-0">Barcode:</span>
                                <span class="font-mono text-white bg-gray-800 px-2 py-1 rounded text-xs sm:text-sm break-all">{{ device_info.barcode }}</span>
                            </div>
                            <div class="flex justify-between gap-2">
                                <span class="text-gray-400 flex-shrink-0">Lagerplatz:</span>
                                <span class="font-semibold text-white text-right">{{ device_info.lagerplatz }}</span>
                            </div>
                            <div class="flex justify-between gap-2">
                                <span class="text-gray-400 flex-shrink-0">Seriennummer:</span>
                                <span class="text-white text-right break-all">{{ device_info.seriennummer or 'Nicht angegeben' }}</span>
                            </div>
                            <div class="flex justify-between gap-2">
                                <span class="text-gray-400 flex-shrink-0">Modell:</span>
                                <span class="text-white text-right break-words">{{ device_info.modell or 'Nicht angegeben' }}</span>
                            </div>
                            <div class="flex justify-between gap-2">
                                <span class="text-gray-400 flex-shrink-0">Instrumentenart:</span>
                                <span class="text-white text-right break-words">{{ device_info.instrumentenart or 'Nicht angegeben' }}</span>
                            </div>
                        </div>
                    </div>

                    {% if device_info.beschreibung %}
                    <!-- Description -->
                    <div class="bg-gray-700/50 p-4 sm:p-5 rounded-lg border border-gray-600">
                        <h3 class="text-base sm:text-lg font-bold text-blue-400 mb-2 sm:mb-3 flex items-center gap-2">
                            <i class="fas fa-align-left"></i>
                            <span>Beschreibung</span>
                        </h3>
                        <div class="text-xs sm:text-sm text-gray-300 whitespace-pre-wrap break-words">{{ device_info.beschreibung }}</div>
                    </div>
                    {% endif %}
                </div>

                <!-- Right Column -->
                <div class="space-y-3 sm:space-y-4">
                    <!-- Status -->
                    <div class="bg-gray-700/50 p-4 sm:p-5 rounded-lg border border-gray-600">
                        <h3 class="text-base sm:text-lg font-bold mb-3 sm:mb-4 flex items-center gap-2
                            {% if device_info.status == 'verfügbar' %}text-green-400
                            {% elif device_info.status == 'defekt' %}text-red-400
                            {% else %}text-yellow-400{% endif %}">
                            <i class="fas fa-signal"></i>
                            <span>Status</span>
                        </h3>
                        <div class="text-center py-3 sm:py-4">
                            <div class="inline-flex items-center justify-center px-4 sm:px-6 py-2 sm:py-3 rounded-lg text-base sm:text-lg font-bold
                                {% if device_info.status == 'verfügbar' %}bg-green-600/20 text-green-400 border-2 border-green-500
                                {% elif device_info.status == 'defekt' %}bg-red-600/20 text-red-400 border-2 border-red-500
                                {% else %}bg-yellow-600/20 text-yellow-400 border-2 border-yellow-500{% endif %}">
                                {% if device_info.status == 'verfügbar' %}
                                    <i class="fas fa-check-circle mr-2"></i>Verfügbar
                                {% elif device_info.status == 'defekt' %}
                                    <i class="fas fa-exclamation-triangle mr-2"></i>Defekt
                                {% else %}
                                    <i class="fas fa-user mr-2"></i>{{ device_info.status }}
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    {% if borrow_info %}
                    <!-- Borrow Info -->
                    <div class="bg-yellow-900/30 p-4 sm:p-5 rounded-lg border-2 border-yellow-600">
                        <h3 class="text-base sm:text-lg font-bold text-yellow-400 mb-3 sm:mb-4 flex items-center gap-2">
                            <i class="fas fa-user-clock"></i>
                            <span>Ausleih-Information</span>
                        </h3>
                        <div class="space-y-2 sm:space-y-3 text-xs sm:text-sm">
                            <div class="flex justify-between gap-2">
                                <span class="text-gray-400 flex-shrink-0">Ausgeliehen an:</span>
                                <span class="font-semibold text-white text-right break-words">{{ borrow_info.mitarbeiter_name }}</span>
                            </div>
                            <div class="flex justify-between gap-2">
                                <span class="text-gray-400 flex-shrink-0">Mitarbeiter-ID:</span>
                                <span class="font-mono text-white break-all">{{ borrow_info.mitarbeiter_id }}</span>
                            </div>
                            <div class="flex justify-between gap-2">
                                <span class="text-gray-400 flex-shrink-0">Ausleih-Datum:</span>
                                <span class="text-white">{{ borrow_info.datum }}</span>
                            </div>
                            {% if borrow_info.email %}
                            <div class="flex justify-between gap-2">
                                <span class="text-gray-400 flex-shrink-0">Email:</span>
                                <span class="text-white text-xs break-all">{{ borrow_info.email }}</span>
                            </div>
                            {% endif %}
                            {% if borrow_info.klasse %}
                            <div class="flex justify-between gap-2">
                                <span class="text-gray-400 flex-shrink-0">Klasse:</span>
                                <span class="text-white">{{ borrow_info.klasse }}</span>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    {% endif %}

                    {% if device_info.kaufdatum or device_info.preis %}
                    <!-- Purchase Info -->
                    <div class="bg-gray-700/50 p-4 sm:p-5 rounded-lg border border-gray-600">
                        <h3 class="text-base sm:text-lg font-bold text-blue-400 mb-3 sm:mb-4 flex items-center gap-2">
                            <i class="fas fa-euro-sign"></i>
                            <span>Kaufinformationen</span>
                        </h3>
                        <div class="space-y-2 sm:space-y-3 text-xs sm:text-sm">
                            {% if device_info.kaufdatum %}
                            <div class="flex justify-between gap-2">
                                <span class="text-gray-400 flex-shrink-0">Kaufdatum:</span>
                                <span class="text-white">{{ device_info.kaufdatum }}</span>
                            </div>
                            {% endif %}
                            {% if device_info.preis %}
                            <div class="flex justify-between gap-2">
                                <span class="text-gray-400 flex-shrink-0">Preis:</span>
                                <span class="text-green-400 font-semibold">{{ device_info.preis }} €</span>
                            </div>
                            {% endif %}
                            {% if device_info.inventarnummer %}
                            <div class="flex justify-between gap-2">
                                <span class="text-gray-400 flex-shrink-0">Inventar-Nr:</span>
                                <span class="font-mono text-white break-all">{{ device_info.inventarnummer }}</span>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="mt-4 sm:mt-6 flex flex-col sm:flex-row gap-2 sm:gap-3">
                <a href="/edit_device/{{ device_info.id }}" 
                   class="flex-1 bg-blue-600 hover:bg-blue-500 active:bg-blue-400 text-white font-bold py-2.5 sm:py-3 px-4 sm:px-6 rounded-lg transition text-center touch-manipulation text-sm sm:text-base">
                    <i class="fas fa-edit mr-2"></i>Bearbeiten
                </a>
                {% if device_info.status == 'verfügbar' %}
                <a href="/borrow" 
                   class="flex-1 bg-green-600 hover:bg-green-500 active:bg-green-400 text-white font-bold py-2.5 sm:py-3 px-4 sm:px-6 rounded-lg transition text-center touch-manipulation text-sm sm:text-base">
                    <i class="fas fa-hand-holding mr-2"></i>Ausleihen
                </a>
                {% endif %}
            </div>
        </div>
    </div>
    {% endif %}
</div>

<!-- Camera Scanner Modal -->
<div id="scannerModal" class="fixed inset-0 bg-black/95 z-50 hidden flex-col">
    <!-- Header -->
    <div class="flex-shrink-0 flex items-center justify-between p-3 sm:p-4 bg-gray-900 border-b border-gray-700">
        <h3 class="text-white font-bold text-base sm:text-lg flex items-center gap-2">
            <i class="fas fa-camera text-green-400"></i>
            <span>QR-Code Scanner</span>
        </h3>
        <button id="closeScanner" 
                class="text-white hover:text-red-400 transition-all duration-200 bg-red-600 hover:bg-red-700 active:bg-red-800 w-9 h-9 sm:w-10 sm:h-10 rounded-lg shadow-lg flex items-center justify-center touch-manipulation">
            <i class="fas fa-times text-lg sm:text-xl"></i>
        </button>
    </div>

    <!-- Scanner Container -->
    <div class="flex-1 flex items-center justify-center p-2 sm:p-4 overflow-auto">
        <div class="w-full max-w-md">
            <div class="bg-gray-900 rounded-xl overflow-hidden shadow-2xl border-2 border-gray-700">
                <div id="qr-reader" class="w-full bg-black"></div>
                <div class="p-3 sm:p-4 bg-gray-800">
                    <div id="scanStatus" class="text-center">
                        <div class="flex items-center justify-center space-x-2 sm:space-x-3 text-blue-400">
                            <div class="animate-pulse">
                                <i class="fas fa-radar text-lg sm:text-xl"></i>
                            </div>
                            <span class="font-semibold text-sm sm:text-base">Suche nach QR-Code...</span>
                        </div>
                        <p class="text-gray-400 text-xs mt-2">Richten Sie die Kamera auf den Code</p>
                    </div>
                    <div class="mt-2 sm:mt-3 text-center">
                        <button id="toggleTorch" class="hidden bg-gray-700 hover:bg-gray-600 active:bg-gray-500 text-white px-3 py-2 rounded-lg transition text-xs sm:text-sm touch-manipulation">
                            <i class="fas fa-lightbulb mr-2"></i><span id="torchText">Licht an</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Device Info Popup Modal -->
<div id="deviceInfoModal" class="fixed inset-0 bg-black/95 z-50 hidden overflow-y-auto">
    <div class="min-h-screen flex items-start sm:items-center justify-center p-2 sm:p-4">
        <div class="relative w-full max-w-4xl my-4 sm:my-8">
            <button id="closeDeviceInfo" 
                    class="sticky top-2 float-right mb-2 sm:absolute sm:-top-12 sm:right-0 text-white text-xs sm:text-sm lg:text-lg hover:text-red-400 transition-all duration-200 bg-gray-800 hover:bg-red-600 active:bg-red-700 px-3 py-2 sm:px-4 rounded-lg z-10 shadow-lg touch-manipulation">
                <i class="fas fa-times mr-1 sm:mr-2"></i>Schließen
            </button>
            <div id="deviceInfoContent" class="bg-gray-900 rounded-lg sm:rounded-2xl shadow-2xl border-2 border-gray-700 overflow-hidden"></div>
        </div>
    </div>
</div>

<style>
@keyframes shake {
    0%, 100% { transform: translateX(0); }
    25% { transform: translateX(-10px); }
    75% { transform: translateX(10px); }
}

.animate-shake {
    animation: shake 0.5s ease-in-out;
}

#qr-reader {
    border: none !important;
}

#qr-reader__dashboard_section,
#qr-reader__header_message {
    display: none !important;
}

#qr-reader video {
    border-radius: 0 !important;
    width: 100% !important;
    max-height: 50vh !important;
    object-fit: cover !important;
}

@media (min-width: 640px) {
    #qr-reader video {
        max-height: 60vh !important;
    }
}

@media (min-height: 800px) and (min-width: 640px) {
    #qr-reader video {
        max-height: 65vh !important;
    }
}

#qr-reader__scan_region {
    max-width: 100% !important;
}

/* Mobile optimizations */
@media (max-width: 640px) {
    body {
        min-height: 100vh;
        min-height: -webkit-fill-available;
    }
    
    .touch-manipulation {
        min-height: 44px;
    }
    
    input {
        font-size: 16px;
    }
}

.touch-manipulation {
    -webkit-tap-highlight-color: rgba(0, 0, 0, 0);
    -webkit-touch-callout: none;
    user-select: none;
}

a, button, input {
    touch-action: manipulation;
}

.break-words {
    word-wrap: break-word;
    overflow-wrap: break-word;
}

.break-all {
    word-break: break-all;
}
</style>

<script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const startCameraBtn = document.getElementById('startCameraBtn');
    const closeScanner = document.getElementById('closeScanner');
    const scannerModal = document.getElementById('scannerModal');
    const deviceInfoModal = document.getElementById('deviceInfoModal');
    const closeDeviceInfo = document.getElementById('closeDeviceInfo');
    const scanStatus = document.getElementById('scanStatus');
    const deviceInfoContent = document.getElementById('deviceInfoContent');
    const toggleTorch = document.getElementById('toggleTorch');
    const torchText = document.getElementById('torchText');
    
    let html5QrCode = null;
    let isScanning = false;
    let torchEnabled = false;

    startCameraBtn.addEventListener('click', async function() {
        try {
            scannerModal.classList.remove('hidden');
            scannerModal.classList.add('flex');
            
            html5QrCode = new Html5Qrcode("qr-reader");
            
            const viewportWidth = Math.min(window.innerWidth * 0.8, 400);
            const qrboxSize = Math.min(viewportWidth * 0.8, 300);
            
            const config = {
                fps: 30,
                qrbox: { width: qrboxSize, height: qrboxSize },
                aspectRatio: 1.0,
                disableFlip: false,
                formatsToSupport: [
                    Html5QrcodeSupportedFormats.QR_CODE,
                    Html5QrcodeSupportedFormats.EAN_13,
                    Html5QrcodeSupportedFormats.EAN_8,
                    Html5QrcodeSupportedFormats.CODE_128,
                    Html5QrcodeSupportedFormats.CODE_39,
                    Html5QrcodeSupportedFormats.UPC_A,
                    Html5QrcodeSupportedFormats.UPC_E
                ],
                experimentalFeatures: {
                    useBarCodeDetectorIfSupported: true
                }
            };

            await html5QrCode.start(
                { facingMode: "environment" },
                config,
                onScanSuccess,
                onScanError
            );
            
            isScanning = true;
            checkTorchSupport();
            
        } catch (error) {
            console.error('Camera error:', error);
            scannerModal.classList.add('hidden');
            scannerModal.classList.remove('flex');
            alert('Fehler beim Zugriff auf die Kamera.\n\nBitte stellen Sie sicher:\n✓ Kamera-Berechtigung erteilt\n✓ Kamera nicht von anderer App genutzt\n✓ HTTPS oder localhost verwendet');
        }
    });

    function onScanSuccess(decodedText, decodedResult) {
        if (!isScanning) return;
        isScanning = false;
        
        if (navigator.vibrate) {
            navigator.vibrate([100, 50, 100]);
        }
        
        scanStatus.innerHTML = `
            <div class="flex items-center justify-center space-x-2 sm:space-x-3 text-green-400">
                <i class="fas fa-check-circle text-xl sm:text-2xl"></i>
                <div class="text-left">
                    <p class="font-bold text-sm sm:text-base">QR-Code erkannt!</p>
                    <p class="font-mono text-xs sm:text-sm break-all">${decodedText}</p>
                </div>
            </div>
        `;
        
        setTimeout(() => {
            stopCamera();
            fetchDeviceInfo(decodedText);
        }, 800);
    }
    
    function onScanError(errorMessage) {
        // Silent
    }

    async function checkTorchSupport() {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ 
                video: { facingMode: "environment" } 
            });
            const videoTrack = stream.getVideoTracks()[0];
            const capabilities = videoTrack.getCapabilities ? videoTrack.getCapabilities() : {};
            
            if (capabilities.torch) {
                toggleTorch.classList.remove('hidden');
            }
            
            stream.getTracks().forEach(track => track.stop());
        } catch (error) {
            console.log('Torch check failed:', error);
        }
    }

    closeScanner.addEventListener('click', stopCamera);
    scannerModal.addEventListener('click', (e) => {
        if (e.target === scannerModal) stopCamera();
    });
    
    toggleTorch.addEventListener('click', async function() {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ 
                video: { facingMode: "environment" } 
            });
            const videoTrack = stream.getVideoTracks()[0];
            
            torchEnabled = !torchEnabled;
            await videoTrack.applyConstraints({
                advanced: [{ torch: torchEnabled }]
            });
            
            torchText.textContent = torchEnabled ? 'Licht aus' : 'Licht an';
            toggleTorch.classList.toggle('bg-yellow-600', torchEnabled);
            toggleTorch.classList.toggle('bg-gray-700', !torchEnabled);
        } catch (error) {
            console.error('Torch toggle error:', error);
        }
    });

    closeDeviceInfo.addEventListener('click', () => {
        deviceInfoModal.classList.add('hidden');
        deviceInfoModal.classList.remove('flex');
    });
    deviceInfoModal.addEventListener('click', (e) => {
        if (e.target === deviceInfoModal) {
            deviceInfoModal.classList.add('hidden');
            deviceInfoModal.classList.remove('flex');
        }
    });

    async function stopCamera() {
        isScanning = false;
        
        if (html5QrCode) {
            try {
                await html5QrCode.stop();
                html5QrCode.clear();
            } catch (error) {
                console.log('Stop camera error:', error);
            }
            html5QrCode = null;
        }
        
        scannerModal.classList.add('hidden');
        scannerModal.classList.remove('flex');
        
        scanStatus.innerHTML = `
            <div class="flex items-center justify-center space-x-2 sm:space-x-3 text-blue-400">
                <div class="animate-pulse">
                    <i class="fas fa-radar text-lg sm:text-xl"></i>
                </div>
                <span class="font-semibold text-sm sm:text-base">Suche nach QR-Code...</span>
            </div>
            <p class="text-gray-400 text-xs mt-2">Richten Sie die Kamera auf den QR-Code</p>
        `;
    }

    async function fetchDeviceInfo(qrCode) {
        try {
            deviceInfoContent.innerHTML = `
                <div class="p-8 sm:p-12 text-center">
                    <i class="fas fa-spinner fa-spin text-4xl sm:text-6xl text-blue-400 mb-4"></i>
                    <p class="text-lg sm:text-xl text-white">Lade Geräte-Information...</p>
                    <p class="text-gray-400 mt-2 text-sm sm:text-base">Code: <span class="font-mono break-all">${qrCode}</span></p>
                </div>
            `;
            deviceInfoModal.classList.remove('hidden');
            deviceInfoModal.classList.add('flex');

            const formData = new FormData();
            formData.append('qr_code', qrCode);
            formData.append('search_device', '');

            const response = await fetch(window.location.pathname, {
                method: 'POST',
                body: formData
            });

            const html = await response.text();
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');
            
            const deviceInfoSection = doc.querySelector('.bg-gray-800.rounded-xl');
            
            if (deviceInfoSection) {
                deviceInfoContent.innerHTML = deviceInfoSection.innerHTML;
            } else {
                deviceInfoContent.innerHTML = `
                    <div class="p-8 sm:p-12 text-center bg-red-900/30 border-2 border-red-600 rounded-2xl m-4">
                        <i class="fas fa-exclamation-triangle text-4xl sm:text-6xl text-red-400 mb-4"></i>
                        <h3 class="text-xl sm:text-2xl font-bold text-white mb-2">Gerät nicht gefunden</h3>
                        <p class="text-red-200 mb-1 text-sm sm:text-base">Kein Gerät mit dem Code gefunden:</p>
                        <p class="text-lg sm:text-xl font-mono font-bold text-red-300 mb-4 break-all px-4">${qrCode}</p>
                        <button onclick="location.reload()" class="bg-blue-600 hover:bg-blue-500 active:bg-blue-400 text-white font-bold py-2.5 sm:py-3 px-4 sm:px-6 rounded-lg transition touch-manipulation text-sm sm:text-base">
                            <i class="fas fa-redo mr-2"></i>Erneut versuchen
                        </button>
                    </div>
                `;
            }
        } catch (error) {
            console.error('Error fetching device info:', error);
            deviceInfoContent.innerHTML = `
                <div class="p-8 sm:p-12 text-center bg-red-900/30 border-2 border-red-600 rounded-2xl m-4">
                    <i class="fas fa-exclamation-circle text-4xl sm:text-6xl text-red-400 mb-4"></i>
                    <h3 class="text-xl sm:text-2xl font-bold text-white mb-2">Fehler beim Laden</h3>
                    <p class="text-red-200 mb-4 text-sm sm:text-base">Die Geräte-Information konnte nicht geladen werden.</p>
                    <button onclick="location.reload()" class="bg-blue-600 hover:bg-blue-500 active:bg-blue-400 text-white font-bold py-2.5 sm:py-3 px-4 sm:px-6 rounded-lg transition touch-manipulation text-sm sm:text-base">
                        <i class="fas fa-redo mr-2"></i>Seite neu laden
                    </button>
                </div>
            `;
        }
    }

    let isSubmitting = false;
    document.querySelectorAll('form').forEach(form => {
        form.addEventListener('submit', function(e) {
            if (isSubmitting) {
                e.preventDefault();
                return false;
            }
            isSubmitting = true;
        });
    }); 
});
</script>
{% endblock %}